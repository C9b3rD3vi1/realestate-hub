<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<section class="mt-12 sm:mt-16 md:mt-20 px-4 md:px-8 flex justify-center">
  <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-500 w-full max-w-5xl rounded-3xl opacity-0 translate-y-6" id="locationCard">
    <div class="card-body p-5 sm:p-8 md:p-10">

      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <h2 class="card-title text-xl sm:text-2xl font-bold text-primary flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sm:h-7 sm:w-7 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          Property Location
        </h2>

        <button id="mapToggleBtn" 
                onclick="toggleMap()" 
                class="btn btn-circle btn-sm md:btn-md btn-ghost hover:bg-primary hover:text-primary-content transition-colors" 
                aria-expanded="false" 
                aria-controls="mapContainer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
          </svg>
        </button>
      </div>

      <!-- Map Container -->
      <div id="mapContainer" 
           class="max-h-0 overflow-hidden transition-[max-height] duration-700 ease-in-out">
        <div class="h-64 sm:h-80 md:h-96 rounded-2xl bg-gradient-to-br from-blue-50 to-blue-100 mt-4 shadow-inner relative flex items-center justify-center">
          
          <!-- Loading Spinner -->
          <div id="mapLoading" class="absolute inset-0 flex items-center justify-center bg-base-200/50 z-10 hidden">
            <span class="loading loading-spinner loading-lg text-primary"></span>
          </div>
          
          <!-- Map -->
          <div id="map" class="h-full w-full rounded-2xl z-0"></div>
        </div>
      </div>

    </div>
  </div>
</section>

<!-- Custom Animations -->
<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }
</style>

<script>
  let mapLoaded = false;
  let leafletMap;

  // Django context (injects coordinates from backend)
  const propertyLat = {{ house.latitude|default:"40.7128" }};
  const propertyLng = {{ house.longitude|default:"-74.0060" }};
  const propertyTitle = "{{ house.title|default:'Property Location' }}";

  function toggleMap() {
    const container = document.getElementById("mapContainer");
    const btn = document.getElementById("mapToggleBtn");
    const isExpanded = btn.getAttribute("aria-expanded") === "true";

    if (isExpanded) {
      container.style.maxHeight = "0";
      btn.setAttribute("aria-expanded", "false");
    } else {
      container.style.maxHeight = container.scrollHeight + "px";
      btn.setAttribute("aria-expanded", "true");

      if (!mapLoaded) {
        loadMap();
      }
    }
  }

  function loadMap() {
    const loadingElement = document.getElementById("mapLoading");
    const mapElement = document.getElementById("map");
    loadingElement.classList.remove("hidden");

    setTimeout(() => {
      // Initialize Leaflet
      leafletMap = L.map(mapElement).setView([propertyLat, propertyLng], 14);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(leafletMap);

      // Add marker with popup
      L.marker([propertyLat, propertyLng])
        .addTo(leafletMap)
        .bindPopup(`<b>${propertyTitle}</b><br>Lat: ${propertyLat}, Lng: ${propertyLng}`)
        .openPopup();

      mapLoaded = true;
      loadingElement.classList.add("hidden");

      // Fix map resize inside collapsible
      setTimeout(() => {
        leafletMap.invalidateSize();
      }, 400);
    }, 800);
  }

  // Scroll-triggered animation
  const card = document.getElementById("locationCard");
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        card.classList.remove("opacity-0", "translate-y-6");
        card.classList.add("animate-fade-in");
        observer.unobserve(card);
      }
    });
  }, { threshold: 0.2 });

  observer.observe(card);
</script>
