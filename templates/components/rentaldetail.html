{% extends 'base.html' %}

{% block extra_head %}
<style>
    /* Main container adjustments - FIXED */
    .page-container {
        width: 100%;
        max-width: 100vw; /* Changed from 100% to 100vw */
        padding: 0 16px;
        margin: 0 auto;
        box-sizing: border-box;
        overflow-x: hidden; /* Prevent horizontal scrolling */
    }
    
    /* Ensure all direct children don't exceed container width */
    .page-container > * {
        max-width: 100%;
    }
    
    .house-gallery {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(2, 200px);
        gap: 8px;
        border-radius: 12px;
        overflow: hidden;
        width: 100%;
    }
    
    .house-gallery img:first-child {
        grid-column: span 2;
        grid-row: span 2;
    }
    
    @media (max-width: 768px) {
        .house-gallery {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(3, 150px);
        }
        
        .house-gallery img:first-child {
            grid-column: span 2;
            grid-row: span 1;
        }
        
        .page-container {
            padding: 0 12px; /* Slightly reduced padding on mobile */
        }
    }
    
    /* Lightbox modal styles */
    .lightbox-modal {
        display: none;
        position: fixed;
        z-index: 100;
        padding-top: 50px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.9);
    }
    
    .lightbox-content {
        position: relative;
        margin: auto;
        padding: 0;
        width: 90%;
        max-width: 1200px;
    }
    
    .lightbox-close {
        color: white;
        position: absolute;
        top: 10px;
        right: 25px;
        font-size: 35px;
        font-weight: bold;
        cursor: pointer;
        z-index: 101;
    }
    
    .lightbox-nav {
        color: white;
        position: absolute;
        top: 50%;
        font-size: 30px;
        font-weight: bold;
        cursor: pointer;
        transform: translateY(-50%);
        padding: 16px;
        background-color: rgba(0,0,0,0.5);
        border-radius: 50%;
        z-index: 101;
    }
    
    .lightbox-prev {
        left: 15px;
    }
    
    .lightbox-next {
        right: 15px;
    }
    
    /* Tabs styling */
    .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
    }
    
    .tab {
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        background-color: #e5e7eb;
        border: none;
        transition: all 0.2s;
    }
    
    .tab-active {
        background-color: #3b82f6;
        color: white;
    }
    
    .tab:hover {
        background-color: #d1d5db;
    }
    
    .tab-active:hover {
        background-color: #2563eb;
    }
    
    /* Ensure grid doesn't cause overflow */
    .grid.grid-cols-1.lg\:grid-cols-3 {
        width: 100%;
        margin: 0;
    }
    
    /* Fix for stats component overflow */
    .stats {
        width: 100%;
        overflow: hidden;
    }
    
    /* Print styles */
    @media print {
        .no-print {
            display: none !important;
        }
        
        .sticky-sidebar {
            position: static !important;
        }
        
        body, html {
            width: 100% !important;
            height: auto !important;
            overflow: visible !important;
            color: black !important;
            background: white !important;
        }
        
        .page-container {
            max-width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        .grid {
            display: block !important;
        }
        
        .lg\:col-span-2, .lg\:col-span-1 {
            width: 100% !important;
        }
        
        .card, .stats, .bg-base-100 {
            border: 1px solid #ddd !important;
            box-shadow: none !important;
            break-inside: avoid;
        }
        
        .house-gallery {
            display: block !important;
            height: auto !important;
        }
        
        .house-gallery img {
            display: none;
        }
        
        .house-gallery img:first-child {
            display: block !important;
            width: 100% !important;
            height: auto !important;
            margin-bottom: 1rem;
        }
        
        .stats-horizontal {
            display: flex !important;
            flex-wrap: wrap;
            justify-content: space-around;
        }
        
        .stat {
            flex: 1 0 45%;
            margin-bottom: 1rem;
        }
        
        a {
            text-decoration: underline !important;
            color: black !important;
        }
        
        a[href]:after {
            content: " (" attr(href) ")";
            font-size: 0.8em;
            font-weight: normal;
        }
        
        #map, #street-view {
            display: none !important;
        }
        
        .btn, .breadcrumbs, .lightbox-modal, .tabs {
            display: none !important;
        }
    }
    
    /* Additional responsive improvements */
    @media (max-width: 1024px) {
        .stats.stats-horizontal {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 640px) {
        .stats.stats-horizontal,
        .stats.stats-vertical {
            display: block;
        }
        
        .stat {
            margin-bottom: 0.5rem;
        }
        
        .flex.flex-col.sm\:flex-row {
            flex-direction: column;
        }
        
        .text-center.sm\:text-left {
            text-align: center;
        }
        
        .page-container {
            padding: 0 8px;
        }
        
        .tabs {
            flex-direction: column;
            align-items: center;
        }
        
        .tab {
            width: 100%;
            text-align: center;
        }
        
        /* Ensure images don't cause overflow */
        img {
            max-width: 100%;
            height: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs py-4 mb-4 flex justify-center no-print">
        <ul class="flex flex-wrap gap-2 justify-center">
            <li><a href="{% url 'home' %}" class="hover:text-primary">Home</a></li>
            <li><a href="{% url 'rentalhouse_index' %}" class="hover:text-primary">Listings</a></li>
            <li class="text-gray-500 truncate">{{ house.title|truncatewords:5 }}</li>
        </ul>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6" style="width: 100%;">
        <!-- Main Content -->
        <div class="lg:col-span-2" style="width: 100%;">
            <!-- Image Gallery with Lightbox -->
            <div class="house-gallery">
                <img src="{{ house.main_image.url }}" alt="{{ house.title }}" 
                     class="w-full h-full object-cover cursor-pointer hover:opacity-90 transition-opacity"
                     onclick="openLightbox(0)">
                
                {% for image in house.images.all %}
                <img src="{{ image.image.url }}" alt="{{ house.title }} - Image {{ forloop.counter }}" 
                     class="w-full h-full object-cover cursor-pointer hover:opacity-90 transition-opacity"
                     onclick="openLightbox({{ forloop.counter }})">
                {% endfor %}
                
                {% if house.images.count == 0 %}
                <!-- Empty state for no additional images -->
                {% endif %}
                
                <!-- Image counter badge -->
                <div class="absolute bottom-4 right-4 bg-black bg-opacity-70 text-white px-3 py-1 rounded-full text-sm no-print">
                    {{ house.images.count|add:1 }} photos
                </div>
            </div>
            
            <!-- Lightbox Modal -->
            <div id="lightbox-modal" class="lightbox-modal no-print">
                <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
                <div class="lightbox-content">
                    <img id="lightbox-img" class="w-full h-auto rounded-lg" alt="">
                </div>
                <a class="lightbox-nav lightbox-prev" onclick="changeSlide(-1)">&#10094;</a>
                <a class="lightbox-nav lightbox-next" onclick="changeSlide(1)">&#10095;</a>
            </div>
            
            <!-- Property Header -->
            <div class="bg-base-100 rounded-box shadow-md p-4 md:p-6 mb-6" style="width: 100%;">
                <div class="flex flex-col sm:flex-row justify-between items-start gap-4 mb-4">
                    <div class="text-center sm:text-left">
                        <h1 class="text-2xl sm:text-3xl font-bold mb-2">{{ house.title }}</h1>
                        <div class="flex items-center text-base-content/70 justify-center sm:justify-start">
                            <i class="fa-solid fa-location-dot mr-2"></i>
                            <span>{{ house.address }}, {{ house.city }}</span>
                        </div>
                    </div>
                    <div class="flex flex-col items-center sm:items-end gap-2 w-full sm:w-auto">
                        <span class="badge badge-lg {% if house.availability %}badge-success{% else %}badge-error{% endif %}">
                            {% if house.availability %}Available{% else %}Booked{% endif %}
                        </span>
                        <p class="text-2xl sm:text-3xl font-bold text-primary">${{ house.price }}/month</p>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="stats stats-vertical md:stats-horizontal shadow w-full mb-6">
                    <div class="stat place-items-center">
                        <div class="stat-title">Size</div>
                        <div class="stat-value text-primary">{{ house.size }} m²</div>
                    </div>
                    
                    <div class="stat place-items-center">
                        <div class="stat-title">Type</div>
                        <div class="stat-value text-primary">{{ house.get_house_type_display }}</div>
                    </div>
                    
                    <div class="stat place-items-center">
                        <div class="stat-title">Bathrooms</div>
                        <div class="stat-value text-primary">{{ house.bathrooms|default:"N/A" }}</div>
                    </div>
                </div>
                
                <!-- Description -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center justify-center sm:justify-start">
                        <i class="fa-solid fa-align-left mr-2 text-primary"></i>
                        Description
                    </h2>
                    <p class="text-base-content leading-relaxed text-center sm:text-left">{{ house.description|linebreaks }}</p>
                </div>
                
                <!-- Amenities -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center justify-center sm:justify-start">
                        <i class="fa-solid fa-star mr-2 text-primary"></i>
                        Amenities
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        {% for amenity in house.amenities.all %}
                        <div class="flex items-center p-3 bg-base-200 rounded-box justify-center sm:justify-start">
                            <i class="{{ amenity.icon }} mr-3 text-secondary text-lg"></i>
                            <span class="font-medium">{{ amenity.name }}</span>
                        </div>
                        {% empty %}
                        <p class="text-base-content/50 col-span-full text-center">No amenities listed.</p>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Property Details -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center justify-center sm:justify-start">
                        <i class="fa-solid fa-info-circle mr-2 text-primary"></i>
                        Property Details
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full">
                            <tbody>
                                <tr>
                                    <td class="font-medium">Property Name</td>
                                    <td class="text-right">#{{ house.slug }}</td>
                                </tr>
                                <tr>
                                    <td class="font-medium">Posted</td>
                                    <td class="text-right">{{ house.created_at|date:"M d, Y" }}</td>
                                </tr>
                                <tr>
                                    <td class="font-medium">Last Updated</td>
                                    <td class="text-right">{{ house.updated_at|date:"M d, Y" }}</td>
                                </tr>
                                <tr>
                                    <td class="font-medium">Furnishing</td>
                                    <td class="text-right">{{ house.furnishing|default:"Not specified" }}</td>
                                </tr>
                                <tr>
                                    <td class="font-medium">Parking</td>
                                    <td class="text-right">{{ house.parking|default:"Not specified" }}</td>
                                </tr>
                                <tr>
                                    <td class="font-medium">Pet Policy</td>
                                    <td class="text-right">{{ house.pet_policy|default:"Not specified" }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Map Section -->
            <div class="bg-base-100 rounded-box shadow-md p-4 md:p-6 mb-6 no-print" style="width: 100%;">
                <h2 class="text-xl font-semibold mb-4 flex items-center justify-center sm:justify-start">
                    <i class="fa-solid fa-map-location-dot mr-2 text-primary"></i>
                    Location
                </h2>
                
                <!-- Map Tabs -->
                <div class="tabs tabs-boxed justify-center mb-4">
                    <button class="tab tab-active" onclick="showMapType('standard')">Standard Map</button>
                    <button class="tab" onclick="showMapType('satellite')">Satellite View</button>
                    <button class="tab" onclick="showStreetViewPanel()">Street View</button>
                </div>
                
                <!-- Map Container -->
                <div class="h-80 bg-base-200 rounded-box mb-4 relative" id="map-container">
                    <div id="map" class="w-full h-full rounded-box"></div>
                    <div id="street-view" class="w-full h-full rounded-box hidden"></div>
                    
                    <!-- Loading indicator -->
                    <div id="map-loading" class="absolute inset-0 flex items-center justify-center bg-base-200 rounded-box">
                        <div class="text-center">
                            <span class="loading loading-spinner loading-lg text-primary"></span>
                            <p class="mt-2">Loading map...</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="https://www.google.com/maps/dir/?api=1&destination={{ house.latitude }},{{ house.longitude }}" 
                       target="_blank" class="btn btn-outline flex-1">
                        <i class="fa-solid fa-directions mr-2"></i> Get Directions
                    </a>
                    <button onclick="openDirections()" class="btn btn-outline flex-1">
                        <i class="fa-solid fa-route mr-2"></i> Open in Google Maps
                    </button>
                </div>
            </div>
            
            <!-- Similar Properties (if available) -->
            {% if similar_rentals %}
            <div class="bg-base-100 rounded-box shadow-md p-4 md:p-6 mb-6" style="width: 100%;">
                <h2 class="text-xl font-semibold mb-6 flex items-center justify-center sm:justify-start">
                    <i class="fa-solid fa-house-circle-check mr-2 text-primary"></i>
                    Similar Rentals
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    {% for property in similar_rentals|slice:":4" %}
                    <div class="card card-compact bg-base-100 shadow-md hover:shadow-lg transition-shadow">
                        <figure>
                            <img src="{{ property.main_image.url }}" alt="{{ property.title }}" class="h-48 w-full object-cover">
                        </figure>
                        <div class="card-body items-center text-center">
                            <h3 class="card-title">{{ property.title|truncatewords:4 }}</h3>
                            <p class="text-primary font-bold text-xl">${{ property.price }}/month</p>
                            <div class="flex items-center text-base-content/60 text-sm">
                                <i class="fa-solid fa-location-dot mr-1"></i>
                                <span>{{ property.city }}</span>
                            </div>
                            <div class="card-actions mt-2">
                                <a href="{% url 'rentalhouse_detail' property.slug %}" class="btn btn-primary">View Details</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Sidebar -->
        <div class="lg:col-span-1" style="width: 100%;">
            <div class="sticky-sidebar space-y-6 no-print" style="position: sticky; top: 1rem;">
                <!-- Agent Info -->
                <div class="card bg-base-100 shadow-md">
                    <div class="card-body items-center text-center">
                        <h3 class="card-title flex items-center">
                            <i class="fa-solid fa-user-tie mr-2 text-primary"></i>
                            Property Agent
                        </h3>
                        <div class="flex flex-col items-center mb-4">
                            <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center text-white text-2xl font-bold mb-2">
                                {{ house.agent.first_name|first }}{{ house.agent.last_name|first }}
                            </div>
                            <div class="text-center">
                                <h4 class="font-semibold">{{ house.agent.get_full_name }}</h4>
                                <p class="text-base-content/60 text-sm">{{ house.agent.email }}</p>
                                {% if house.agent.profile.phone %}
                                <p class="text-base-content/60 text-sm">{{ house.agent.profile.phone }}</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-actions w-full">
                            <a href="tel:{{ house.agent.profile.phone }}" class="btn btn-primary flex-1">
                                <i class="fa-solid fa-phone mr-1"></i> Call
                            </a>
                            <a href="mailto:{{ house.agent.email }}" class="btn btn-outline flex-1">
                                <i class="fa-solid fa-envelope mr-1"></i> Email
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="card bg-base-100 shadow-md">
                    <div class="card-body items-center">
                        {% if user.is_authenticated %}
                        <button id="favorite-btn" class="btn {% if is_favorited %}btn-error{% else %}btn-outline{% endif %} w-full mb-2" 
                                hx-post="{% url 'toggle_favorite' house.id %}" 
                                hx-trigger="click" 
                                hx-swap="none">
                            {% if is_favorited %}
                            <i class="fa-solid fa-heart mr-2"></i> Remove from Favorites
                            {% else %}
                            <i class="fa-regular fa-heart mr-2"></i> Add to Favorites
                            {% endif %}
                        </button>
                        {% endif %}
                        
                        <div class="flex space-x-2 w-full">
                            <button onclick="window.print()" class="btn btn-outline flex-1">
                                <i class="fa-solid fa-print mr-1"></i> Print
                            </button>
                            <button onclick="shareProperty()" class="btn btn-outline flex-1">
                                <i class="fa-solid fa-share-alt mr-1"></i> Share
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Contact Form -->
                <div class="card bg-base-100 shadow-md">
                    <div class="card-body">
                        <h3 class="card-title flex items-center justify-center">
                            <i class="fa-solid fa-envelope mr-2 text-primary"></i>
                            Contact Agent
                        </h3>
                        <form id="contact-form" hx-post="{% url 'contact_agent' %}" hx-swap="none">
                            {{ contact_form.house }}
                            <div class="space-y-4">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Your Name</span>
                                    </label>
                                    {{ contact_form.name }}
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Email</span>
                                    </label>
                                    {{ contact_form.email }}
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Phone (Optional)</span>
                                    </label>
                                    {{ contact_form.phone }}
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Message</span>
                                    </label>
                                    {{ contact_form.message }}
                                </div>
                                <button type="submit" class="btn btn-primary w-full">
                                    <i class="fa-solid fa-paper-plane mr-2"></i> Send Message
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Booking Form -->
                {% if house.availability %}
                <div class="card bg-base-100 shadow-md">
                    <div class="card-body">
                        <h3 class="card-title flex items-center justify-center">
                            <i class="fa-solid fa-calendar-days mr-2 text-primary"></i>
                            Schedule a Viewing
                        </h3>
                        <form id="booking-form" hx-post="{% url 'book_house' %}" hx-swap="none">
                            {{ booking_form.house }}
                            <div class="space-y-4">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Preferred Date</span>
                                    </label>
                                    {{ booking_form.start_date }}
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Time</span>
                                    </label>
                                    <select class="select select-bordered w-full" name="time_slot">
                                        <option value="9:00 AM">9:00 AM</option>
                                        <option value="10:00 AM">10:00 AM</option>
                                        <option value="11:00 AM">11:00 AM</option>
                                        <option value="1:00 PM">1:00 PM</option>
                                        <option value="2:00 PM">2:00 PM</option>
                                        <option value="3:00 PM">3:00 PM</option>
                                        <option value="4:00 PM">4:00 PM</option>
                                    </select>
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Message (Optional)</span>
                                    </label>
                                    {{ booking_form.message }}
                                </div>
                                <button type="submit" class="btn btn-accent w-full">
                                    <i class="fa-solid fa-calendar-check mr-2"></i> Request Viewing
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Map Script -->
<script>
    let map;
    let streetViewPanorama;
    let marker;
    let currentView = 'standard';
    
    function initMap() {
        const location = { lat: {{ house.latitude }}, lng: {{ house.longitude }} };
        
        // Initialize standard map
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 15,
            center: location,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            styles: [
                {
                    "featureType": "all",
                    "elementType": "labels.text.fill",
                    "stylers": [{ "saturation": 36 }, { "color": "#000000" }, { "lightness": 40 }]
                },
                {
                    "featureType": "all",
                    "elementType": "labels.text.stroke",
                    "stylers": [{ "visibility": "on" }, { "color": "#000000" }, { "lightness": 16 }]
                },
                {
                    "featureType": "all",
                    "elementType": "labels.icon",
                    "stylers": [{ "visibility": "off" }]
                },
                {
                    "featureType": "administrative",
                    "elementType": "geometry.fill",
                    "stylers": [{ "color": "#000000" }, { "lightness": 20 }]
                },
                {
                    "featureType": "administrative",
                    "elementType": "geometry.stroke",
                    "stylers": [{ "color": "#000000" }, { "lightness": 17 }, { "weight": 1.2 }]
                },
                {
                    "featureType": "landscape",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#000000" }, { "lightness": 20 }]
                },
                {
                    "featureType": "poi",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#000000" }, { "lightness": 21 }]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "geometry.fill",
                    "stylers": [{ "color": "#000000" }, { "lightness": 17 }]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "geometry.stroke",
                    "stylers": [{ "color": "#000000" }, { "lightness": 29 }, { "weight": 0.2 }]
                },
                {
                    "featureType": "road.arterial",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#000000" }, { "lightness": 18 }]
                },
                {
                    "featureType": "road.local",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#000000" }, { "lightness": 16 }]
                },
                {
                    "featureType": "transit",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#000000" }, { "lightness": 19 }]
                },
                {
                    "featureType": "water",
                    "elementType": "geometry",
                    "stylers": [{ "color": "#000000" }, { "lightness": 17 }]
                }
            ]
        });
        
        // Add marker
        marker = new google.maps.Marker({
            position: location,
            map: map,
            title: "{{ house.title }}",
            icon: {
                url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
            }
        });
        
        // Initialize street view (but don't show it yet)
        streetViewPanorama = new google.maps.StreetViewPanorama(
            document.getElementById("street-view"),
            {
                position: location,
                pov: { heading: 34, pitch: 10 },
                zoom: 1
            }
        );
        
        // Hide loading indicator
        document.getElementById('map-loading').style.display = 'none';
    }
    
    function showMapType(type) {
        // Update tabs
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('tab-active'));
        event.target.classList.add('tab-active');
        
        // Show appropriate view
        if (type === 'standard') {
            document.getElementById('map').classList.remove('hidden');
            document.getElementById('street-view').classList.add('hidden');
            currentView = 'standard';
            
            // Reset map to standard view
            map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
        } else if (type === 'satellite') {
            document.getElementById('map').classList.remove('hidden');
            document.getElementById('street-view').classList.add('hidden');
            currentView = 'satellite';
            
            // Change to satellite view
            map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
        }
    }
    
    function showStreetViewPanel() {
        // Update tabs
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('tab-active'));
        event.target.classList.add('tab-active');
        
        // Show street view
        document.getElementById('map').classList.add('hidden');
        document.getElementById('street-view').classList.remove('hidden');
        currentView = 'streetview';
    }
    
    function openDirections() {
        window.open(`https://www.google.com/maps/dir/?api=1&destination={{ house.latitude }},{{ house.longitude }}`, '_blank');
    }
    
    function openStreetView() {
        window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint={{ house.latitude }},{{ house.longitude }}`, '_blank');
    }
    
    // Handle Google Maps API loading
    window.gm_authFailure = function() {
        document.getElementById('map-loading').innerHTML = `
            <div class="text-center p-4">
                <i class="fa-solid fa-triangle-exclamation text-3xl text-error mb-2"></i>
                <p class="font-semibold">Failed to load maps</p>
                <p class="text-sm">Please check your API key and try again.</p>
            </div>
        `;
    };

    // Lightbox functionality
    let currentSlide = 0;
    const slides = [
        "{{ house.main_image.url }}",
        {% for image in house.images.all %}
        "{{ image.image.url }}",
        {% endfor %}
    ];
    
    function openLightbox(index) {
        currentSlide = index;
        document.getElementById("lightbox-modal").style.display = "block";
        document.getElementById("lightbox-img").src = slides[currentSlide];
        document.body.style.overflow = "hidden";
    }
    
    function closeLightbox() {
        document.getElementById("lightbox-modal").style.display = "none";
        document.body.style.overflow = "auto";
    }
    
    function changeSlide(n) {
        currentSlide += n;
        if (currentSlide >= slides.length) currentSlide = 0;
        if (currentSlide < 0) currentSlide = slides.length - 1;
        document.getElementById("lightbox-img").src = slides[currentSlide];
    }
    
    // Close lightbox when clicking outside content
    document.getElementById("lightbox-modal").addEventListener("click", function(e) {
        if (e.target === this) closeLightbox();
    });
    
    // Keyboard navigation for lightbox
    document.addEventListener("keydown", function(e) {
        if (document.getElementById("lightbox-modal").style.display === "block") {
            if (e.key === "Escape") closeLightbox();
            if (e.key === "ArrowLeft") changeSlide(-1);
            if (e.key === "ArrowRight") changeSlide(1);
        }
    });
    
    // Share functionality
    function shareProperty() {
        if (navigator.share) {
            navigator.share({
                title: "{{ house.title }}",
                text: "Check out this rental property: {{ house.title }}",
                url: window.location.href
            })
            .catch(console.error);
        } else {
            // Fallback for browsers that don't support Web Share API
            navigator.clipboard.writeText(window.location.href)
            .then(() => {
                alert('Link copied to clipboard!');
            })
            .catch(err => {
                console.error('Could not copy text: ', err);
            });
        }
    }
    
    // Handle form submissions
    document.getElementById('contact-form').addEventListener('htmx:afterRequest', function(e) {
        const response = JSON.parse(e.detail.xhr.responseText);
        if (response.status === 'success') {
            alert(response.message);
            this.reset();
        } else {
            alert(response.errors || 'There was an error sending your message.');
        }
    });
    
    document.getElementById('booking-form').addEventListener('htmx:afterRequest', function(e) {
        const response = JSON.parse(e.detail.xhr.responseText);
        if (response.status === 'success') {
            alert(response.message);
            this.reset();
        } else {
            alert(response.errors || 'There was an error with your booking request.');
        }
    }
    
    document.getElementById('favorite-btn').addEventListener('htmx:afterRequest', function(e) {
        const response = JSON.parse(e.detail.xhr.responseText);
        if (response.status === 'added') {
            this.innerHTML = '<i class="fa-solid fa-heart mr-2"></i> Remove from Favorites';
            this.classList.remove('btn-outline');
            this.classList.add('btn-error');
            alert('Added to favorites!');
        } else if (response.status === 'removed') {
            this.innerHTML = '<i class="fa-regular fa-heart mr-2"></i> Add to Favorites';
            this.classList.remove('btn-error');
            this.classList.add('btn-outline');
            alert('Removed from favorites.');
        }
    });
    
    // Fix for print layout issues
    window.addEventListener('beforeprint', function() {
        // Force all elements to static positioning for print
        document.querySelectorAll('*').forEach(el => {
            if (window.getComputedStyle(el).position === 'sticky') {
                el.style.position = 'static';
            }
        });
    });
</script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ map_api_key }}&callback=initMap&libraries=places">
</script>
{% endblock %}